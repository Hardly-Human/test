<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Details</title>
  <style>
    .comment-section {
      margin-top: 30px;
    }
    .comment-form {
      margin-top: 20px;
    }
    .comment {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Image Details</h1>

  <img src="<%= image.url %>" alt="Image" style="max-width: 600px; display: block; margin-bottom: 20px;">

  <!-- Handling if image.user is null -->
  <p>Uploaded by: 
    <% if (image.user) { %>
      <%= image.user.name %>
    <% } else { %>
      Unknown User
    <% } %>
  </p>
  <p>Uploaded on: <%= new Date(image.createdAt).toDateString() %></p>
  <p>Short URL: <a href="/i/<%= image.shortUrl %>">/i/<%= image.shortUrl %></a></p>

  <div class="comment-section">
    <h2>Comments</h2>

    <% if (image.comments.length > 0) { %>
      <% image.comments.forEach(function(comment) { %>
        <div class="comment">
          <!-- Handle case when comment.user is null -->
          <p><strong>
            <% if (comment.user) { %>
              <%= comment.user.name %>
            <% } else { %>
              Unknown User
            <% } %>
          </strong> 
          <!-- Convert comment.createdAt to Date -->
          (<%= new Date(comment.createdAt).toDateString() %>)</p>
          <p><%= comment.text %></p>
        </div>
      <% }) %>
    <% } else { %>
      <p>No comments yet. Be the first to comment!</p>
    <% } %>

    <% if (user) { %>
      <div class="comment-form">
        <h3>Leave a Comment</h3>
        <form action="/images/<%= image.shortUrl %>/comments" method="POST">
          <textarea name="commentText" rows="4" cols="50" required></textarea><br>
          <button type="submit">Submit</button>
        </form>
      </div>
    <% } else { %>
      <p><a href="/login">Login to leave a comment</a></p>
    <% } %>
  </div>

  <a href="/">Back to Home</a>
</body>
</html>
